// Defining the API key and URL
const API_KEY = 'demo'; //Set demo for now as there is a daily limit for AlphaVantage actual key TXGWHOHIPVV1GPA0 to insert during publication
const API_URL = 'https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=';
const DAILY_API_URL = 'https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=';
const OVERVIEW_URL = 'https://www.alphavantage.co/query?function=OVERVIEW&symbol=';

// Store historical prices in an array
let historicalPrices = [];

// Function to fetch and store historical prices
const fetchHistoricalPrices = async (symbol) => {
  try {
    const response = await fetch(`${DAILY_API_URL}${symbol}&apikey=${API_KEY}`);
    const data = await response.json();
    historicalPrices = Object.entries(data['Time Series (Daily)']).map(([date, info]) => ({
      date,
      price: info['4. close'],
    }));
    displayHistoricalPrices();
  } catch (error) {
    console.error('Error fetching historical prices:', error);
  }
};

// Function to display historical prices
const displayHistoricalPrices = () => {
  const historicalPriceList = document.getElementById('historicalPriceList');
  historicalPriceList.innerHTML = '';

  historicalPrices.forEach((data) => {
    const listItem = document.createElement('li');
    listItem.textContent = `${data.date}: $${data.price}`;
    listItem.dataset.date = data.date; 
    historicalPriceList.appendChild(listItem);
  });
};

// Filter function txo display prices for a selected date
const filterHistoricalPrices = (selectedDate) => {
    const historicalPriceList = document.getElementById('historicalPriceList');
    const listItems = historicalPriceList.getElementsByTagName('li');
    let hasData = false;
  
    for (let i = 0; i < listItems.length; i++) {
      const listItem = listItems[i];
      const date = listItem.dataset.date;
  
      if (date === selectedDate) {
        listItem.style.display = 'block';
        hasData = true;
      } else {
        listItem.style.display = 'none';
      }
    }
  
    const noDataMessage = historicalPriceList.querySelector('.no-data-message');
    
    if (!hasData) {
      if (!noDataMessage) {
        // If no data found and no message exists, display the message
        const newNoDataMessage = document.createElement('p');
        newNoDataMessage.textContent = 'No Available Data for the Selected Date';
        newNoDataMessage.classList.add('no-data-message');
        historicalPriceList.appendChild(newNoDataMessage);
      }
    } else {
      // If data is found, remove any "No Available Data" message
      if (noDataMessage) {
        historicalPriceList.removeChild(noDataMessage);
      }
    }
  };
  
// Function to fetch and display current stock price
const fetchStockPrice = async (symbol) => {
  try {
    const response = await fetch(`${API_URL}${symbol}&interval=5min&apikey=${API_KEY}`);
    const data = await response.json();
    const timeSeries = data['Time Series (5min)'];
    const latestData = timeSeries[Object.keys(timeSeries)[0]];
    const stockPrice = latestData['4. close'];

    const stockInfoDiv = document.getElementById('stockInfo');
    stockInfoDiv.innerHTML = `<strong>Current Stock Price:</strong> $${stockPrice}`;
  } catch (error) {
    console.error('Error fetching stock price:', error);
  }
};

// Function to fetch and display fundamental data
const fetchFundamentalData = async (symbol) => {
    try {
      const response = await fetch(`${OVERVIEW_URL}${symbol}&apikey=${API_KEY}`);
      const data = await response.json();
  
      document.getElementById('fundamentalSymbol').innerHTML = `<strong>Symbol:</strong> ${data['Symbol']}`;
      document.getElementById('fundamentalName').innerHTML = `<strong>Name:</strong> ${data['Name']}`;
      document.getElementById('fundamentalIndustry').innerHTML = `<strong>Industry:</strong> ${data['Industry']}`;
      document.getElementById('fundamentalMarketCap').innerHTML = `<strong>Market Cap:</strong> ${data['MarketCapitalization']}`;
      document.getElementById('fundamentalExchange').innerHTML = `<strong>Exchange:</strong> ${data['Exchange']}`;
      // Add more fundamental data fields as needed
    } catch (error) {
      console.error('Error fetching fundamental data:', error);
    }
  };
  
// Event listener for the "Get Stock Price" button
document.getElementById('fetchStockPrice').addEventListener('click', () => {
  const symbol = document.getElementById('stockSymbol').value;
  if (symbol) {
    fetchStockPrice(symbol);
    fetchHistoricalPrices(symbol);
    fetchFundamentalData(symbol);
  } else {
    alert('Please enter a valid stock symbol.');
  }
});

// Event listener for the date filter input
document.getElementById('dateFilter').addEventListener('input', (event) => {
  const selectedDate = event.target.value;
  filterHistoricalPrices(selectedDate);
});
